# é¡¹ç›®ç»“æ„è¯´æ˜

ComfyUI APIä¸­é—´ä»¶ - å®Œæ•´é¡¹ç›®ç»“æ„æ–‡æ¡£

## ğŸ“ ç›®å½•ç»“æ„

```
Comfyapi/
â”œâ”€â”€ core/                           # æ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ __init__.py                 # æ ¸å¿ƒæ¨¡å—å¯¼å‡º
â”‚   â”œâ”€â”€ comfyui_client.py          # ComfyUIå®¢æˆ·ç«¯å°è£…ï¼ˆå«å›¾ç‰‡ä¸Šä¼ ï¼‰
â”‚   â”œâ”€â”€ managers.py                 # ä»»åŠ¡å’Œè¿æ¥ç®¡ç†å™¨
â”‚   â”œâ”€â”€ models.py                   # æ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ response.py                 # ç»Ÿä¸€å“åº”æ ¼å¼
â”‚   â”œâ”€â”€ utils.py                    # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ api/                        # APIè·¯ç”±æ¨¡å—
â”‚       â”œâ”€â”€ __init__.py             # APIæ¨¡å—å¯¼å‡º
â”‚       â”œâ”€â”€ system.py               # ç³»ç»Ÿç›¸å…³APIï¼ˆå¥åº·æ£€æŸ¥ã€è¯Šæ–­ç­‰ï¼‰
â”‚       â”œâ”€â”€ task.py                 # ä»»åŠ¡æŸ¥è¯¢API
â”‚       â”œâ”€â”€ media.py                # åª’ä½“æ–‡ä»¶APIï¼ˆå›¾ç‰‡ã€è§†é¢‘è·å–å’Œä¸Šä¼ ï¼‰
â”‚       â”œâ”€â”€ workflow.py             # é€šç”¨å·¥ä½œæµAPI
â”‚       â””â”€â”€ specialized/            # ä¸“ç”¨å·¥ä½œæµAPIã€æ–°å¢ã€‘
â”‚           â”œâ”€â”€ __init__.py         # ä¸“ç”¨APIæ¨¡å—å¯¼å‡º
â”‚           â”œâ”€â”€ README.md           # ä¸“ç”¨APIä½¿ç”¨æ–‡æ¡£
â”‚           â”œâ”€â”€ text2image.py       # æ–‡ç”Ÿå›¾API
â”‚           â””â”€â”€ wan22_i2v.py        # Wan2.2å›¾ç”Ÿè§†é¢‘API
â”‚
â”œâ”€â”€ static/                         # é™æ€æ–‡ä»¶ï¼ˆå‰ç«¯é¡µé¢ï¼‰
â”‚   â”œâ”€â”€ index.html                  # ä¸»é¡µï¼ˆå·¥ä½œæµè°ƒè¯•å·¥å…·ï¼‰
â”‚   â”œâ”€â”€ app.js                      # ä¸»é¡µJavaScriptï¼ˆå«å›¾ç‰‡ä¸Šä¼ é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ style.css                   # ä¸»é¡µæ ·å¼
â”‚   â””â”€â”€ specialized/                # ä¸“ç”¨APIæµ‹è¯•é¡µé¢ã€æ–°å¢ã€‘
â”‚       â”œâ”€â”€ index.html              # ä¸“ç”¨APIä¸»å…¥å£
â”‚       â”œâ”€â”€ text2image.html         # æ–‡ç”Ÿå›¾æµ‹è¯•é¡µé¢
â”‚       â”œâ”€â”€ text2image.js           # æ–‡ç”Ÿå›¾é¡µé¢é€»è¾‘
â”‚       â”œâ”€â”€ wan22_i2v.html          # Wan2.2è§†é¢‘æµ‹è¯•é¡µé¢
â”‚       â”œâ”€â”€ wan22_i2v.js            # è§†é¢‘é¡µé¢é€»è¾‘
â”‚       â”œâ”€â”€ style.css               # å…±äº«æ ·å¼
â”‚       â””â”€â”€ README.md               # å‰ç«¯é¡µé¢ä½¿ç”¨æ–‡æ¡£
â”‚
â”œâ”€â”€ workflows/                      # å·¥ä½œæµæ–‡ä»¶
â”‚   â”œâ”€â”€ HiDream-l1.json            # HiDreamæ–‡ç”Ÿå›¾å·¥ä½œæµ
â”‚   â”œâ”€â”€ qwen_t2i_distill.json      # Qwenæ–‡ç”Ÿå›¾å·¥ä½œæµ
â”‚   â”œâ”€â”€ Wan2.2-I2V-15s.json        # Wan2.2 15ç§’è§†é¢‘å·¥ä½œæµ
â”‚   â””â”€â”€ jiedian.json                # å•ä¸ª5ç§’ç‰‡æ®µå·¥ä½œæµ
â”‚
â”œâ”€â”€ uploads/                        # ä¸Šä¼ æ–‡ä»¶ç›®å½•
â”œâ”€â”€ outputs/                        # è¾“å‡ºæ–‡ä»¶ç›®å½•
â”‚
â”œâ”€â”€ main.py                         # FastAPIä¸»åº”ç”¨å…¥å£
â”œâ”€â”€ start.py                        # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ config.py                       # é…ç½®æ–‡ä»¶
â”œâ”€â”€ requirements.txt                # Pythonä¾èµ–
â”‚
â”œâ”€â”€ API_USAGE.md                    # é€šç”¨APIä½¿ç”¨æ–‡æ¡£
â”œâ”€â”€ WAN22_I2V_API.md               # Wan2.2 APIå®Œæ•´æ–‡æ¡£
â”œâ”€â”€ POSTMAN_GUIDE.md               # Postmanä½¿ç”¨æŒ‡å—
â”œâ”€â”€ FRONTEND_UPDATE_LOG.md         # å‰ç«¯æ›´æ–°æ—¥å¿—
â”œâ”€â”€ PROJECT_STRUCTURE.md            # æœ¬æ–‡ä»¶
â””â”€â”€ README.md                       # é¡¹ç›®è¯´æ˜
```

## ğŸ¯ æ¶æ„è®¾è®¡

### 1. åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          å‰ç«¯å±‚ (Frontend)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  é€šç”¨å·¥å…·é¡µ   â”‚   ä¸“ç”¨APIæµ‹è¯•é¡µ   â”‚    â”‚
â”‚  â”‚ index.html   â”‚ specialized/     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         APIè·¯ç”±å±‚ (Routing)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  é€šç”¨API     â”‚   ä¸“ç”¨API         â”‚    â”‚
â”‚  â”‚ system       â”‚ specialized/     â”‚    â”‚
â”‚  â”‚ task         â”‚ - text2image     â”‚    â”‚
â”‚  â”‚ media        â”‚ - wan22_i2v      â”‚    â”‚
â”‚  â”‚ workflow     â”‚                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ComfyUIå®¢æˆ·ç«¯                    â”‚   â”‚
â”‚  â”‚  - å·¥ä½œæµæäº¤                     â”‚   â”‚
â”‚  â”‚  - å›¾ç‰‡ä¸Šä¼                        â”‚   â”‚
â”‚  â”‚  - ä»»åŠ¡è½®è¯¢                       â”‚   â”‚
â”‚  â”‚  - ç»“æœæå–                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ComfyUIæœåŠ¡å™¨ (External)            â”‚
â”‚         192.168.48.123:8188             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. APIåˆ†ç±»

#### é€šç”¨API (`core/api/`)
æä¾›åŸºç¡€ComfyUIåŠŸèƒ½çš„å°è£…ï¼š

- **system.py**: ç³»ç»Ÿç›‘æ§
  - `/api/health` - å¥åº·æ£€æŸ¥
  - `/api/diagnose` - è¿æ¥è¯Šæ–­
  - `/api/queue` - é˜Ÿåˆ—ä¿¡æ¯

- **task.py**: ä»»åŠ¡ç®¡ç†
  - `/api/task/{task_id}` - æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
  - `/api/tasks` - ä»»åŠ¡åˆ—è¡¨
  - `/api/history` - å†å²è®°å½•

- **media.py**: åª’ä½“å¤„ç†
  - `/api/image/{filename}` - è·å–å›¾ç‰‡
  - `/api/video/{filename}` - è·å–è§†é¢‘
  - `/api/upload/image` - ä¸Šä¼ å›¾ç‰‡ã€æ–°å¢ã€‘

- **workflow.py**: å·¥ä½œæµæ“ä½œ
  - `/api/workflow/submit` - æäº¤å·¥ä½œæµ
  - `/api/workflow/upload` - ä¸Šä¼ å·¥ä½œæµ
  - `/api/workflows` - å·¥ä½œæµåˆ—è¡¨

#### ä¸“ç”¨API (`core/api/specialized/`)ã€æ–°å¢ã€‘
é’ˆå¯¹ç‰¹å®šåœºæ™¯çš„é«˜çº§å°è£…ï¼š

- **text2image.py**: æ–‡ç”Ÿå›¾API
  - `/api/text2image` - å¿«é€Ÿæ–‡ç”Ÿå›¾
  - åŸºäº Qwen Image Distill æ¨¡å‹
  - å‚æ•°ç®€åŒ–ï¼Œæ˜“äºä½¿ç”¨

- **wan22_i2v.py**: Wan2.2å›¾ç”Ÿè§†é¢‘API
  - `/api/wan22_i2v/upload_and_generate` - ä¸€é”®ç”Ÿæˆ
  - `/api/wan22_i2v/generate` - ä½¿ç”¨å·²ä¸Šä¼ å›¾ç‰‡
  - æ”¯æŒ5-30ç§’æ™ºèƒ½æ‹¼æ¥
  - è‡ªåŠ¨å¤„ç†ç‰‡æ®µè¡”æ¥

### 3. å‰ç«¯ç»“æ„

#### ä¸»é¡µé¢ (`static/`)
- **index.html**: é€šç”¨å·¥ä½œæµè°ƒè¯•å·¥å…·
  - ä¸Šä¼ å’Œç¼–è¾‘ä»»æ„å·¥ä½œæµ
  - åŠ¨æ€å‚æ•°æå–å’Œä¿®æ”¹
  - å®æ—¶ä»»åŠ¡ç›‘æ§
  - æ”¯æŒLoadImageèŠ‚ç‚¹å›¾ç‰‡ä¸Šä¼ ã€æ–°å¢ã€‘

#### ä¸“ç”¨æµ‹è¯•é¡µé¢ (`static/specialized/`)ã€æ–°å¢ã€‘
- **index.html**: ä¸“ç”¨APIå…¥å£
  - å±•ç¤ºæ‰€æœ‰å¯ç”¨ä¸“ç”¨API
  - å¡ç‰‡å¼å¯¼èˆª

- **text2image.html**: æ–‡ç”Ÿå›¾æµ‹è¯•
  - ç®€åŒ–çš„å‚æ•°ç•Œé¢
  - å®æ—¶ç”Ÿæˆé¢„è§ˆ
  - ç»“æœä¸‹è½½

- **wan22_i2v.html**: è§†é¢‘ç”Ÿæˆæµ‹è¯•
  - å›¾ç‰‡ä¸Šä¼ ç•Œé¢
  - æ—¶é•¿é€‰æ‹©å™¨ï¼ˆ5-30ç§’ï¼‰
  - è¿›åº¦è·Ÿè¸ª
  - è§†é¢‘æ’­æ”¾é¢„è§ˆ

## ğŸ”„ è¯·æ±‚æµç¨‹ç¤ºä¾‹

### æ–‡ç”Ÿå›¾æµç¨‹

```
ç”¨æˆ· â†’ text2image.html
       â†“
    è¾“å…¥æç¤ºè¯å’Œå‚æ•°
       â†“
    text2image.js
       â†“ POST /api/text2image
    specialized/text2image.py
       â†“
    ç”Ÿæˆworkflow + æäº¤ComfyUI
       â†“
    è¿”å›task_id
       â†“
    è½®è¯¢ /api/task/{task_id}
       â†“
    æ˜¾ç¤ºç”Ÿæˆçš„å›¾ç‰‡
```

### å›¾ç”Ÿè§†é¢‘æµç¨‹

```
ç”¨æˆ· â†’ wan22_i2v.html
       â†“
    ä¸Šä¼ å›¾ç‰‡ + è¾“å…¥å‚æ•°
       â†“
    wan22_i2v.js
       â†“ POST /api/wan22_i2v/upload_and_generate
    specialized/wan22_i2v.py
       â†“
    1. ä¸Šä¼ å›¾ç‰‡åˆ°ComfyUI inputæ–‡ä»¶å¤¹
    2. æ ¹æ®æ—¶é•¿ç”Ÿæˆworkflow
       - 5ç§’: 1ä¸ªç‰‡æ®µ
       - 10ç§’: 2ä¸ªç‰‡æ®µæ‹¼æ¥
       - 15ç§’: 3ä¸ªç‰‡æ®µæ‹¼æ¥
       - ...
    3. æäº¤workflowåˆ°ComfyUI
       â†“
    è¿”å›task_id
       â†“
    è½®è¯¢ /api/task/{task_id}
       â†“
    æ˜¾ç¤ºç”Ÿæˆçš„è§†é¢‘
```

## ğŸ“Š æ•°æ®æµ

### å›¾ç‰‡ä¸Šä¼ æ•°æ®æµã€æ–°å¢ã€‘

```
å‰ç«¯æ–‡ä»¶é€‰æ‹©
    â†“
FormDataå¯¹è±¡
    â†“
POST /api/upload/image
    â†“
media.py: upload_image()
    â†“
comfyui_client.py: async_upload_image()
    â†“
ComfyUIæœåŠ¡å™¨ /upload/image
    â†“
ä¿å­˜åˆ°ComfyUI/input/æ–‡ä»¶å¤¹
    â†“
è¿”å›æ–‡ä»¶å
    â†“
å‰ç«¯æ›´æ–°workflowä¸­çš„imageå‚æ•°
    â†“
æäº¤å®Œæ•´workflow
```

## ğŸ¨ è®¾è®¡åŸåˆ™

### 1. å…³æ³¨ç‚¹åˆ†ç¦»
- **é€šç”¨åŠŸèƒ½** â†’ `core/api/`
- **ä¸“ç”¨åŠŸèƒ½** â†’ `core/api/specialized/`
- **åŸºç¡€å·¥å…·** â†’ `static/`
- **ä¸“ç”¨æµ‹è¯•** â†’ `static/specialized/`

### 2. ä»£ç å¤ç”¨
- å…±äº«ComfyUIå®¢æˆ·ç«¯
- ç»Ÿä¸€å“åº”æ ¼å¼
- å¤ç”¨ä»»åŠ¡ç®¡ç†å™¨
- å…±äº«æ ·å¼ç³»ç»Ÿ

### 3. æ˜“äºæ‰©å±•
- æ¨¡å—åŒ–è®¾è®¡
- æ¸…æ™°çš„æ¥å£å®šä¹‰
- è¯¦ç»†çš„æ–‡æ¡£è¯´æ˜
- ä¸€è‡´çš„ä»£ç é£æ ¼

### 4. ç”¨æˆ·å‹å¥½
- ç›´è§‚çš„UIè®¾è®¡
- å®æ—¶çŠ¶æ€åé¦ˆ
- æ¸…æ™°çš„é”™è¯¯æç¤º
- å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å¯åŠ¨æœåŠ¡
```bash
python start.py
```

### è®¿é—®é¡µé¢
- ä¸»é¡µ: http://localhost:8000
- ä¸“ç”¨APIæµ‹è¯•: http://localhost:8000/static/specialized/

### APIæ–‡æ¡£
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## ğŸ“ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„ä¸“ç”¨API

1. **åç«¯å¼€å‘**
   ```bash
   # åœ¨ core/api/specialized/ åˆ›å»ºæ–°æ–‡ä»¶
   vim core/api/specialized/my_new_api.py
   
   # æ›´æ–° __init__.py
   vim core/api/specialized/__init__.py
   
   # åœ¨ main.py æ³¨å†Œè·¯ç”±
   vim main.py
   ```

2. **å‰ç«¯å¼€å‘**
   ```bash
   # åœ¨ static/specialized/ åˆ›å»ºæµ‹è¯•é¡µé¢
   vim static/specialized/my_new_api.html
   vim static/specialized/my_new_api.js
   
   # æ›´æ–°å…¥å£é¡µé¢
   vim static/specialized/index.html
   ```

3. **æ–‡æ¡£æ›´æ–°**
   - æ›´æ–° `core/api/specialized/README.md`
   - æ›´æ–° `static/specialized/README.md`
   - æ·»åŠ APIä½¿ç”¨ç¤ºä¾‹

## ğŸ”§ æŠ€æœ¯æ ˆ

### åç«¯
- **FastAPI**: ç°ä»£Python Webæ¡†æ¶
- **aiohttp**: å¼‚æ­¥HTTPå®¢æˆ·ç«¯
- **Pydantic**: æ•°æ®éªŒè¯
- **websocket-client**: WebSocketæ”¯æŒ

### å‰ç«¯
- **åŸç”ŸJavaScript**: æ— æ¡†æ¶ä¾èµ–
- **HTML5 + CSS3**: ç°ä»£Webæ ‡å‡†
- **FormData API**: æ–‡ä»¶ä¸Šä¼ 
- **Fetch API**: HTTPè¯·æ±‚

### ComfyUIé›†æˆ
- **APIæ ¼å¼workflow**: JSONæ ¼å¼
- **å›¾ç‰‡ä¸Šä¼ **: multipart/form-data
- **ä»»åŠ¡è½®è¯¢**: å®šæœŸHTTPè¯·æ±‚
- **åª’ä½“è·å–**: ç›´æ¥URLè®¿é—®

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

- å¼‚æ­¥I/Oæ“ä½œ
- HTTPä¼šè¯å¤ç”¨
- åˆç†çš„è½®è¯¢é—´éš”
- ç»“æœç¼“å­˜æœºåˆ¶
- é™æ€æ–‡ä»¶CDNï¼ˆå¯é€‰ï¼‰

## ğŸ”’ å®‰å…¨è€ƒè™‘

- CORSé…ç½®
- æ–‡ä»¶ç±»å‹éªŒè¯
- æ–‡ä»¶å¤§å°é™åˆ¶
- è·¯å¾„æ³¨å…¥é˜²æŠ¤
- é”™è¯¯ä¿¡æ¯è„±æ•

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [APIä½¿ç”¨æ–‡æ¡£](API_USAGE.md)
- [Wan2.2 APIæ–‡æ¡£](WAN22_I2V_API.md)
- [ä¸“ç”¨APIæ–‡æ¡£](core/api/specialized/README.md)
- [å‰ç«¯é¡µé¢æ–‡æ¡£](static/specialized/README.md)

---

**æœ€åæ›´æ–°**: 2025-10-28  
**ç‰ˆæœ¬**: v2.0.0  
**ç»´æŠ¤è€…**: ComfyAPI Team

